<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Hints - Дашборд</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: #0f172a;
            color: #f8fafc;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #818cf8; }
        h2 { margin-bottom: 12px; font-size: 16px; color: #94a3b8; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        .stat-label { color: #94a3b8; }
        .stat-value { font-weight: 600; color: #f8fafc; }
        .stat-value.good { color: #22c55e; }
        .stat-value.warning { color: #eab308; }
        .stat-value.error { color: #ef4444; }
        
        .chart-container { height: 200px; margin-top: 12px; }
        
        .sessions-list { max-height: 400px; overflow-y: auto; }
        .session-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #334155;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .session-item:hover {
            background: #475569;
            transform: translateX(4px);
        }
        .session-date { font-size: 12px; color: #94a3b8; }
        .session-stats { font-size: 14px; margin-top: 4px; }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 4px;
        }
        .badge-tech { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
        .badge-exp { background: rgba(52, 211, 153, 0.2); color: #34d399; }
        .badge-gen { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }
        
        .refresh-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-btn:hover { background: #4f46e5; }
        
        .error-item {
            padding: 8px;
            margin-bottom: 4px;
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Live Hints - Аналитика</h1>
        <button class="refresh-btn" onclick="loadStats()">Обновить данные</button>
        
        <div class="grid">
            <!-- STT Stats -->
            <div class="card">
                <h2>STT (Speech-to-Text)</h2>
                <div class="stat-row">
                    <span class="stat-label">Транскрипций</span>
                    <span class="stat-value" id="stt-count">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Средняя латентность</span>
                    <span class="stat-value" id="stt-avg">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Min / Max</span>
                    <span class="stat-value" id="stt-minmax">-</span>
                </div>
                <div class="chart-container">
                    <canvas id="stt-chart"></canvas>
                </div>
            </div>
            
            <!-- LLM Stats -->
            <div class="card">
                <h2>LLM (Language Model)</h2>
                <div class="stat-row">
                    <span class="stat-label">Подсказок</span>
                    <span class="stat-value" id="llm-count">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Средняя латентность</span>
                    <span class="stat-value" id="llm-avg">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Min / Max</span>
                    <span class="stat-value" id="llm-minmax">-</span>
                </div>
                <div class="chart-container">
                    <canvas id="llm-chart"></canvas>
                </div>
            </div>
            
            <!-- Question Types -->
            <div class="card">
                <h2>Типы вопросов</h2>
                <div class="stat-row">
                    <span class="stat-label">Technical</span>
                    <span class="stat-value badge badge-tech" id="qt-tech">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Experience</span>
                    <span class="stat-value badge badge-exp" id="qt-exp">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">General</span>
                    <span class="stat-value badge badge-gen" id="qt-gen">-</span>
                </div>
                <div class="chart-container">
                    <canvas id="qt-chart"></canvas>
                </div>
            </div>
            
            <!-- Cache Stats -->
            <div class="card">
                <h2>Кэш</h2>
                <div class="stat-row">
                    <span class="stat-label">Cache Hits</span>
                    <span class="stat-value good" id="cache-hits">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Cache Misses</span>
                    <span class="stat-value" id="cache-misses">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Hit Rate</span>
                    <span class="stat-value" id="cache-rate">-</span>
                </div>
            </div>
            
            <!-- Errors -->
            <div class="card">
                <h2>Последние ошибки</h2>
                <div id="errors-list"></div>
            </div>
            
            <!-- Sessions -->
            <div class="card" style="grid-column: span 2;">
                <h2>Последние сессии</h2>
                <div class="sessions-list" id="sessions-list"></div>
            </div>
        </div>
    </div>
    
    <script>
        let sttChart, llmChart, qtChart;
        
        async function loadStats() {
            try {
                const resp = await fetch('/api/stats?hours=24');
                const data = await resp.json();
                
                // STT
                document.getElementById('stt-count').textContent = data.stt.count;
                document.getElementById('stt-avg').textContent = data.stt.avg_ms.toFixed(0) + ' ms';
                document.getElementById('stt-minmax').textContent = 
                    data.stt.min_ms.toFixed(0) + ' / ' + data.stt.max_ms.toFixed(0) + ' ms';
                updateChart('stt', data.stt.latencies);
                
                // LLM
                document.getElementById('llm-count').textContent = data.llm.count;
                document.getElementById('llm-avg').textContent = data.llm.avg_ms.toFixed(0) + ' ms';
                document.getElementById('llm-minmax').textContent = 
                    data.llm.min_ms.toFixed(0) + ' / ' + data.llm.max_ms.toFixed(0) + ' ms';
                updateChart('llm', data.llm.latencies);
                
                // Question types
                document.getElementById('qt-tech').textContent = data.question_types.technical;
                document.getElementById('qt-exp').textContent = data.question_types.experience;
                document.getElementById('qt-gen').textContent = data.question_types.general;
                updateQTChart(data.question_types);
                
                // Cache
                document.getElementById('cache-hits').textContent = data.cache.hits;
                document.getElementById('cache-misses').textContent = data.cache.misses;
                document.getElementById('cache-rate').textContent = data.cache.hit_rate.toFixed(1) + '%';
                
                // Errors
                const errorsList = document.getElementById('errors-list');
                if (data.errors.length === 0) {
                    errorsList.innerHTML = '<p style="color:#94a3b8">Нет ошибок</p>';
                } else {
                    errorsList.innerHTML = data.errors.map(e => 
                        `<div class="error-item">${e.timestamp}: [${e.component}] ${e.message}</div>`
                    ).join('');
                }
                
            } catch (e) {
                console.error('Ошибка загрузки статистики:', e);
            }
            
            loadSessions();
        }
        
        async function loadSessions() {
            try {
                const resp = await fetch('/api/sessions');
                const data = await resp.json();
                
                const list = document.getElementById('sessions-list');
                if (data.sessions.length === 0) {
                    list.innerHTML = '<p style="color:#94a3b8">Нет сессий</p>';
                    return;
                }
                
                list.innerHTML = data.sessions.map(s => `
                    <div class="session-item">
                        <div class="session-date">${new Date(s.date).toLocaleString('ru-RU')}</div>
                        <div class="session-stats">
                            Транскрипт: ${(s.transcript || '').split('\\n').length} строк, 
                            Подсказки: ${(s.hints || '').split('\\n').length} строк
                        </div>
                    </div>
                `).join('');
                
            } catch (e) {
                console.error('Ошибка загрузки сессий:', e);
            }
        }
        
        function updateChart(type, data) {
            const ctx = document.getElementById(type + '-chart').getContext('2d');
            const labels = data.map((_, i) => i + 1);
            
            const chartRef = type === 'stt' ? sttChart : llmChart;
            if (chartRef) chartRef.destroy();
            
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Латентность (ms)',
                        data: data,
                        borderColor: type === 'stt' ? '#22c55e' : '#6366f1',
                        backgroundColor: type === 'stt' ? 'rgba(34, 197, 94, 0.1)' : 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: 'rgba(148, 163, 184, 0.1)' } }
                    }
                }
            });
            
            if (type === 'stt') sttChart = chart;
            else llmChart = chart;
        }
        
        function updateQTChart(data) {
            const ctx = document.getElementById('qt-chart').getContext('2d');
            if (qtChart) qtChart.destroy();
            
            qtChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Technical', 'Experience', 'General'],
                    datasets: [{
                        data: [data.technical, data.experience, data.general],
                        backgroundColor: ['#60a5fa', '#34d399', '#9ca3af']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }
        
        loadStats();
        setInterval(loadStats, 30000);
    </script>
</body>
</html>
