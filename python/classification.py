"""
Классификация вопросов для LLM сервера
Без зависимостей от FastAPI - для тестирования
"""


def classify_question(text: str) -> str:
    """
    Классифицирует вопрос по типу: experience / technical / general
    """
    text_lower = text.lower()
    
    experience_keywords = [
        'опыт', 'работал', 'проект', 'делал', 'команда', 'задача',
        'ситуация', 'пример', 'как вы', 'расскажите о себе',
        'почему вы', 'ваш опыт', 'последний проект', 'достижения',
        'опишите', 'решили', 'сложную', 'справились', 'столкнулись'
    ]
    
    technical_keywords = [
        'что такое', 'как работает', 'объясни', 'разница между',
        'чем отличается', 'принцип', 'алгоритм', 'структура данных',
        'паттерн', 'зачем нужен', 'когда использовать', 'определение'
    ]
    
    exp_score = sum(1 for kw in experience_keywords if kw in text_lower)
    tech_score = sum(1 for kw in technical_keywords if kw in text_lower)
    
    if exp_score > tech_score and exp_score > 0:
        return 'experience'
    elif tech_score > exp_score and tech_score > 0:
        return 'technical'
    else:
        return 'general'


def get_max_tokens_for_type(question_type: str) -> int:
    """Возвращает рекомендуемое количество токенов по типу вопроса"""
    return {
        'experience': 900,   # Развёрнутые ответы с STAR
        'technical': 700,    # Определение + объяснение + пример
        'general': 500       # Краткие ответы
    }.get(question_type, 600)


def get_temperature_for_type(question_type: str) -> float:
    """Возвращает рекомендуемую temperature по типу вопроса"""
    return {
        'experience': 0.8,   # Более креативные ответы
        'technical': 0.5,    # Точные технические ответы
        'general': 0.7
    }.get(question_type, 0.7)


def build_contextual_prompt(question_type: str, user_context: str) -> str:
    """
    Строит развёрнутый промпт в зависимости от типа вопроса.
    Цель: качественные ответы на 1-2 минуты речи.
    """
    # Разделяем резюме и вакансию если они объединены
    resume_part = user_context
    vacancy_part = ''
    if '## Вакансия:' in user_context:
        parts = user_context.split('## Вакансия:', 1)
        resume_part = parts[0].strip()
        vacancy_part = parts[1].strip() if len(parts) > 1 else ''
    
    if question_type == 'experience':
        # STAR формат для вопросов про опыт — развёрнутый ответ на 1-2 минуты
        context_full = resume_part[:2000] if resume_part else ''
        vacancy_info = f'\n\n## Вакансия (подчёркивай релевантный опыт):\n{vacancy_part[:500]}' if vacancy_part else ''
        return (
            'Ты AI-ассистент для технических собеседований. Помогаешь кандидату отвечать уверенно и профессионально.\n\n'
            '## ВАЖНО: Отвечай на ПОСЛЕДНИЙ вопрос интервьюера!\n\n'
            '## Формат ответа (STAR) — 200-300 слов (1.5-2 минуты речи):\n\n'
            '1. **Краткий тезис** — что делал, где, в какой роли (1-2 предложения)\n'
            '2. **Ситуация** — контекст проекта, проблема которую решал\n'
            '3. **Действия** — конкретные шаги, технологии, твоя роль в команде\n'
            '4. **Результат** — метрики (%, время, деньги), чему научился\n\n'
            '## Требования к стилю:\n'
            '- Тон: уверенный, заинтересованный, демонстрирующий экспертность\n'
            '- **ОБЯЗАТЕЛЬНО** используй проекты и технологии из резюме\n'
            '- Конкретные цифры и факты, не общие фразы\n'
            '- Показывай личностные качества: инициативность, ответственность\n'
            '- Формат: markdown (жирный для ключевых терминов)\n\n'
            f'## Резюме кандидата (ИСПОЛЬЗУЙ ЭТУ ИНФОРМАЦИЮ):\n{context_full}'
            f'{vacancy_info}'
        )
    elif question_type == 'technical':
        # Структурированный технический ответ
        context_short = resume_part[:500] if resume_part else ''
        return (
            'Ты AI-ассистент для технических собеседований. Даёшь экспертные ответы.\n\n'
            '## ВАЖНО: Отвечай на ПОСЛЕДНИЙ вопрос интервьюера!\n\n'
            '## Формат ответа — 150-250 слов:\n\n'
            '**Краткий ответ** (5-7 пунктов по 1 предложению):\n'
            '- Главная идея концепции\n'
            '- Ключевое отличие от аналогов\n'
            '- Основное применение\n'
            '- Важная техническая деталь\n'
            '- Преимущество использования\n\n'
            '**Подробный ответ** (3 раздела):\n'
            '1. **Основной ответ** — развёрнутое объяснение (2-3 предложения)\n'
            '2. **Ключевые моменты** — технические детали (3-5 пунктов)\n'
            '3. **Практический контекст** — пример из проекта или pet-проекта\n\n'
            '## Требования:\n'
            '- Используй markdown: **жирный**, `код`, списки\n'
            '- Код оформляй в ```python блоках\n'
            '- Если в резюме есть релевантный опыт — ОБЯЗАТЕЛЬНО упомяни\n'
            '- Тон: уверенный, технический, понятный\n\n'
            f'## Контекст кандидата:\n{context_short}'
        )
    else:
        # General — сбалансированный ответ
        context_short = resume_part[:800] if resume_part else ''
        return (
            'Ты AI-ассистент для технических собеседований.\n\n'
            '## ВАЖНО: Отвечай на ПОСЛЕДНИЙ вопрос интервьюера!\n\n'
            '## Требования:\n'
            '- Длина: 100-200 слов\n'
            '- Формат: markdown\n'
            '- Тон: уверенный, профессиональный\n'
            '- Опирайся на контекст кандидата\n'
            '- Если вопрос технический — давай конкретику\n'
            '- Если вопрос про опыт — используй примеры из резюме\n\n'
            f'## Контекст кандидата:\n{context_short}'
        )
